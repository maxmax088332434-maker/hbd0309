<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¥ç§˜äºŒé¸ä¸€ï½œå¯æ„›ç´„æœƒæ…¶ç”Ÿ</title>
  <style>
    * { box-sizing: border-box; }
    :root{
      --bg1:#fff1f6;
      --bg2:#f0f9ff;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#f1f5f9;
      --primary:#ec4899;
      --primary2:#8b5cf6;
      --shadow: 0 22px 55px rgba(17,24,39,0.12);
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 10%, var(--bg2), transparent 60%),
        radial-gradient(1000px 700px at 80% 0%, var(--bg1), transparent 55%),
        linear-gradient(135deg, #ffffff, #fdf2f8);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
      padding: 18px;
    }

    .card {
      background: var(--card);
      width: 100%;
      max-width: 520px;
      padding: calc(22px + env(safe-area-inset-top))
               calc(16px + env(safe-area-inset-right))
               calc(18px + env(safe-area-inset-bottom))
               calc(16px + env(safe-area-inset-left));
      border-radius: 22px;
      box-shadow: var(--shadow);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .glow {
      position: absolute;
      inset: -60px;
      background:
        radial-gradient(circle at 20% 20%, rgba(236,72,153,0.18), transparent 45%),
        radial-gradient(circle at 80% 10%, rgba(139,92,246,0.15), transparent 45%),
        radial-gradient(circle at 70% 80%, rgba(14,165,233,0.12), transparent 45%);
      pointer-events: none;
    }

    h1 {
      font-size: 20px;
      margin: 0 0 6px;
      letter-spacing: 0.2px;
    }

    .subtitle {
      font-size: 13px;
      color: var(--muted);
      margin: 0 0 18px;
      line-height: 1.4;
    }

    .pillbar {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 0 0 14px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(236,72,153,0.12), rgba(139,92,246,0.10));
      border: 1px solid rgba(236,72,153,0.18);
      font-size: 12px;
      color: #374151;
    }

    .stepTitle {
      margin: 10px 0 6px;
      font-size: 18px;
    }

    .hint {
      margin: 0 0 16px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .options {
      display: grid;
      grid-template-columns: 1fr; /* mobile-first */
      gap: 14px;
      margin: 12px 0 10px;
    }

    .options.three {
      grid-template-columns: 1fr;
    }

    @media (min-width: 520px) {
      .options { grid-template-columns: 1fr 1fr; }
      .options.three { grid-template-columns: 1fr 1fr 1fr; }
    }

    .option {
      padding: 16px 14px;
      min-height: 64px;
      border-radius: 16px;
      border: 2px solid #f3f4f6;
      cursor: pointer;
      transition: transform 0.15s ease, border-color 0.15s ease, background 0.15s ease;
      font-size: 16px;
      background: linear-gradient(180deg, #ffffff, #fafafa);
      position: relative;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      text-align: left;
    }

    .option b{ display:block; font-size: 15px; }

    .option small{
      display:block;
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.3;
    }

    .option:hover {
      border-color: #d1d5db;
      transform: translateY(-2px);
    }

    .option.selected {
      border-color: rgba(236,72,153,0.8);
      background: linear-gradient(180deg, rgba(236,72,153,0.10), rgba(139,92,246,0.06));
      font-weight: 700;
    }

    .actions{
      display:flex;
      gap: 10px;
      justify-content: center;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    button {
      padding: 14px 18px;
      min-height: 48px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      color: #fff;
      font-size: 15px;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(236,72,153,0.25);
    }

    button.secondary{
      background: #fff;
      color: #374151;
      border: 1px solid #e5e7eb;
      box-shadow: none;
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
    }

    .reveal {
      margin-top: 14px;
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 14px 14px;
      background: linear-gradient(180deg, #ffffff, #fdf2f8);
      text-align: left;
      transform: translateY(6px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease, transform 0.25s ease;
      position: relative;
      overflow: hidden;
    }

    .reveal.show{
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .reveal h3{
      margin: 0 0 6px;
      font-size: 14px;
      color: #111827;
    }

    .reveal .big{
      font-size: 18px;
      font-weight: 800;
      margin: 2px 0 8px;
    }

    .reveal .desc{
      margin: 0;
      color: #374151;
      font-size: 14px;
      line-height: 1.5;
    }

    .summary {
      margin-top: 14px;
      text-align: left;
      border-top: 1px dashed #e5e7eb;
      padding-top: 12px;
      display:none;
    }

    .summary.show{ display:block; }

    .summary h2{
      font-size: 16px;
      margin: 0 0 8px;
    }

    .summary ul{
      margin: 0;
      padding-left: 18px;
      color:#374151;
      line-height: 1.4;
    }

    footer {
      margin-top: 14px;
      font-size: 12px;
      color: #9ca3af;
    }

    /* ===== gate animations ===== */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-6px); }
      40% { transform: translateX(6px); }
      60% { transform: translateX(-4px); }
      80% { transform: translateX(4px); }
    }

    .shake { animation: shake 0.35s ease; }

    @keyframes pop {
      0% { transform: scale(0.98); opacity: 0.6; }
      60% { transform: scale(1.02); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    .pop { animation: pop 0.35s ease; }

    @keyframes floatHeart {
      0% { transform: translateY(0) scale(1); opacity: 0; }
      10% { opacity: 1; }
      100% { transform: translateY(-90px) scale(1.25); opacity: 0; }
    }

    .heart {
      position: absolute;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 16px;
      pointer-events: none;
      opacity: 0;
      animation: floatHeart 0.9s ease forwards;
      filter: drop-shadow(0 6px 10px rgba(236,72,153,0.20));
    }

    @keyframes fadeOutUp {
      to { opacity: 0; transform: translateY(-6px) scale(0.98); }
    }

    .gate-success {
      animation: fadeOutUp 0.35s ease forwards;
    }

    /* iOS: prevent button tap delay / highlight */
    button, .option { touch-action: manipulation; }
  </style>
</head>
<body>
  <div class="card">
    <div class="glow"></div>

    <h1>ğŸ’– ç¥ç§˜é¸æ“‡ï¼šå¯æ„›ç´„æœƒæ…¶ç”Ÿ</h1>
    <p class="subtitle">åœ¨é–‹å§‹ä¹‹å‰ï¼Œå…ˆé€šéä¸€å€‹å°å°çš„é€šé—œå¯†èª ğŸ’Œ</p>

    <!-- ğŸ” èµ·å§‹é€šé—œå¯†èªï¼ˆåªåœ¨ç¬¬ä¸€æ­¥å‰é¡¯ç¤ºï¼‰ -->
    <div class="reveal show" id="gateBox">
      <h3>ğŸ” è«‹è¼¸å…¥é€šé—œå¯†èª</h3>
      <div class="big">æº–å‚™å¥½äº†å—ï¼Ÿ</div>
      <p class="desc">è¼¸å…¥æ­£ç¢ºå¾Œï¼Œæ‰èƒ½é–‹å§‹ä»Šå¤©çš„é¸æ“‡ã€‚</p>
      <div class="actions" style="justify-content:flex-start; margin-top: 10px;">
        <input id="gateInput" placeholder="è¼¸å…¥é€šé—œå¯†èª" style="flex:1; min-width: 180px; padding: 14px 16px; border-radius: 999px; border: 1px solid #e5e7eb; font-size: 16px;" />
        <button class="secondary" id="gateBtn" type="button">é€²å…¥</button>
      </div>
      <p class="desc" id="gateMsg" style="margin-top:10px; color:#6b7280; font-size:12px;">æç¤ºï¼šé€™æ˜¯ä¸€å¥å°ä½ å¾ˆé‡è¦çš„è©±ã€‚</p>
    </div>

    <div class="pillbar">
      <span class="pill" id="progressPill">æ­¥é©Ÿ 1 / 5</span>
      <span class="pill" id="moodPill">ä»Šæ—¥å¿ƒæƒ…ï¼šç”œç”œçš„</span>
    </div>

    <div class="stepTitle" id="stepTitle">â€”</div>
    <p class="hint" id="hint">â€”</p>

    <div class="options" id="options"><!-- options injected --></div>

    <div class="actions">
      <button id="revealBtn" disabled>æˆ‘é¸å¥½äº†ï¼Œæ­æ›‰ï¼</button>
    </div>

    <!-- ğŸ”’ ç´„æœƒç•¶å¤©æ­¥é©Ÿé–å®šå€ï¼ˆåªé è§£é–ç¢¼ï¼‰ -->
    <div class="reveal" id="lockBox">
      <h3>ğŸ”’ é€™ä¸€æ­¥éœ€è¦è¼¸å…¥è§£é–ç¢¼</h3>
      <div class="big" id="lockMsg">â€”</div>
      <p class="desc" id="countdown">â€”</p>
      <div class="actions" style="justify-content:flex-start; margin-top: 10px;">
        <input id="codeInput" placeholder="è¼¸å…¥è§£é–ç¢¼" style="flex:1; min-width: 180px; padding: 14px 16px; border-radius: 999px; border: 1px solid #e5e7eb; font-size: 16px;" />
        <button class="secondary" id="unlockBtn" type="button">è§£é–</button>
      </div>
      <p class="desc" style="margin-top:10px; color:#6b7280; font-size:12px;">æç¤ºï¼šè§£é–ç¢¼æ­£ç¢ºå°±æœƒé–‹æ”¾å¾ŒçºŒæ­¥é©Ÿã€‚</p>
    </div>

    <div class="reveal" id="revealBox" aria-live="polite">
      <h3>ğŸ€ ä½ é€™ä¸€æ­¥æŠ½åˆ°çš„æ˜¯ï¼š</h3>
      <div class="big" id="revealBig">â€”</div>
      <p class="desc" id="revealDesc">â€”</p>
      <div class="actions" style="justify-content:flex-end; margin-top: 10px;">
        <button class="secondary" id="nextBtn" type="button">ä¸‹ä¸€æ­¥ âœ</button>
      </div>
    </div>

    <div class="summary" id="summary">
      <h2>ğŸ“Œ ä½ çš„ç´„æœƒæ…¶ç”Ÿè·¯ç·š</h2>
      <ul id="summaryList"></ul>
      <div class="actions" style="justify-content:flex-start; margin-top: 10px;">
        <button id="copyBtn" class="secondary" type="button">è¤‡è£½çµæœ</button>
      </div>
    </div>

    <footer>é€™æ˜¯å¯åˆ†äº«çš„å‰ç«¯ç‰ˆæœ¬ï¼ˆç„¡å¾Œç«¯ï¼‰ã€‚é¸æ“‡æœƒä¿å­˜åœ¨ç€è¦½å™¨ä¸­ã€‚</footer>
  </div>

  <script>
    // ====== ç´„æœƒç•¶å¤©è§£é–è¨­å®šï¼ˆåªé è§£é–ç¢¼ï¼‰ ======
    const unlockConfig = {
      unlockAtISO: null, // ä¿ç•™æ¬„ä½ä½†ä¸ä½¿ç”¨
      unlockCode: "HBD0309"
    };

    const STORAGE_KEY = "mystery_date_v1";
    const GATE_PHRASE = "æˆ‘æ„›æ—æ™ºæ¶µ"; // èµ·å§‹é€šé—œå¯†èª

    // âœ… å·²å¥—ç”¨ä½ çµ¦çš„é¤å»³èˆ‡ç¦®ç‰©ï¼Œä¸¦ä½¿ç”¨å®šç¨¿æ–‡æ¡ˆã€‚
    const steps = [
      {
        phase: "pre",
        title: "Step 1ï¼šåˆé¤é¢¨æ ¼ï¼ˆä¸‰é¸ä¸€ï¼‰",
        hint: "å…ˆç›²é¸ä¸€å€‹é¢¨æ ¼ï¼›é¸å®Œæ‰æœƒæ­æ›‰æ˜¯å“ªä¸€é–“ã€‚",
        mood: "æœŸå¾…å€¼ +1",
        options: {
          A: {
            big: "ğŸ¶ æ—¥å¼è·äººç³»ï½œæ»¿é…Œå±‹ï¼ˆå°åŒ—å¸‚å¤§åŒå€ï¼‰",
            desc: "èµ°ä¸€å€‹ä½èª¿ä½†å¾ˆè¬›ç©¶çš„è·¯ç·šï¼šç¯€å¥å‰›å¥½ã€ç´°ç¯€åˆ°ä½ï¼Œé©åˆå¥½å¥½åƒé£¯ã€å¥½å¥½èŠå¤©ã€‚"
          },
          B: {
            big: "ğŸŒ¿ æº«æŸ”ç”Ÿæ´»ç³»ï½œç¦¾åå¿ƒï¼ˆæ–°åŒ—å¸‚ä¸‰é‡å€ï¼‰",
            desc: "ä¸æ˜¯è¯éº—è·¯ç·šï¼Œè€Œæ˜¯æœƒè®“äººæ”¾é¬†ä¸‹ä¾†çš„èˆ’æœæ„Ÿï¼›åƒå®Œå¿ƒæƒ…æœƒè®Šå¾—å¾ˆå¹³éœã€‚"
          },
          C: {
            big: "ğŸ”¥ å„€å¼æ„Ÿæ…¶ç”Ÿç³»ï½œå±±ä¸Šèµ°èµ° æ—¥å¼ç‡’è‚‰ï¼ˆå°åŒ—å¸‚ä¸­æ­£å€ï¼‰",
            desc: "ä»Šå¤©é€™ä¸€é¤æœ¬èº«å°±æ˜¯ä¸€å€‹é‡é»ï¼šå¾ˆæ˜ç¢ºåœ°è®“äººæ„Ÿè¦ºåˆ°ã€ä»Šå¤©ä¸ä¸€æ¨£ã€ã€‚"
          }
        }
      },
      {
        phase: "pre",
        title: "Step 2ï¼šç”Ÿæ—¥ç¦®ç‰©ï¼ˆäºŒé¸ä¸€ï¼‰",
        hint: "å…ˆé¸æ–¹å‘ï¼›æ­æ›‰å¾Œä½ æ‰æœƒçŸ¥é“æˆ‘æº–å‚™çš„æ˜¯å“ªä¸€ç¨®ã€‚",
        mood: "å·å·æº–å‚™ä¸­",
        options: {
          A: {
            big: "ğŸ§¼ ç”Ÿæ´»å‡ç´šæ´¾",
            desc: "æ˜¯ä¸€å€‹æœƒè®“ç”Ÿæ´»è®Šå¾—æ›´ä¿è½çš„å°æ±è¥¿ã€‚ä¸ç”¨å¼µæšï¼Œä½†æœƒé»˜é»˜è®“æ•´å€‹äººçœ‹èµ·ä¾†æ›´ä¹¾æ·¨ã€æ›´æœ‰ç²¾ç¥ã€‚"
          },
          B: {
            big: "ğŸ’— å¿ƒå¿ƒå¿µå¿µæ´¾ï¼ˆä½ ä¾†æ±ºå®šç´°ç¯€ï¼‰",
            desc: "ç´°ç¯€äº¤çµ¦ä½ æ±ºå®šï¼Œæˆ‘åªè² è²¬è¨‚ä¸€å€‹å°å°çš„ä¸Šé™ï¼šNT$4,000ã€‚"
          }
        }
      },
      {
        phase: "day",
        title: "Step 3ï¼šDress codeï¼ˆç•¶å¤©æ‰é¸ï¼‰",
        hint: "ç´„æœƒç•¶å¤©å†ä¸€èµ·é¸ï¼Œæ‰æœ‰é©šå–œæ„Ÿã€‚",
        mood: "å¯æ„›è­¦å ±",
        options: {
          A: { big: "ğŸ‘Ÿ ä¼‘é–’è·¯ç·š", desc: "èˆ’æœå°±å¥½ï¼Œèƒ½èµ°ã€èƒ½åã€èƒ½ç¬‘ï¼›ä»Šå¤©çš„é‡é»ä¸æ˜¯æ‹˜è¬¹ã€‚" },
          B: { big: "ğŸ‘— å¾®æ­£å¼è·¯ç·š", desc: "ç¨å¾®æ‰“æ‰®ä¸€ä¸‹ï¼Œä»Šå¤©å¾ˆå€¼å¾—è¢«å¥½å¥½è¨˜ä½ã€‚" }
        }
      },
      {
        phase: "day",
        title: "Step 4ï¼šé£¯å¾Œè¡Œç¨‹ï¼ˆç•¶å¤©æ‰é¸ï¼‰",
        hint: "åƒå®Œé£¯ä¹‹å¾Œï¼Œè¦æŠŠæ™‚é–“äº¤çµ¦å“ªç¨®ç¯€å¥ï¼Ÿ",
        mood: "å¿ƒå‹•è·¯ç·š",
        options: {
          A: { big: "ğŸ® å¤§ç¨»åŸ•æ•£æ­¥", desc: "é‚Šèµ°é‚ŠèŠã€é‚Šæ‹é‚Šç¬‘ï¼Œä»Šå¤©æœƒæ…¢æ…¢è®Šæˆä¸€æ®µå›æ†¶ã€‚" },
          B: { big: "ğŸš² æ²³æ¿±å…¬åœ’é¨è…³è¸è»Š", desc: "é¢¨å¹éä¾†å¾ˆèˆ’æœï¼Œé¨ä¸€æ®µè·¯ï¼ŒæŠŠå¹¸ç¦æ„Ÿæ‹‰é•·ã€‚" }
        }
      },
      {
        phase: "day",
        title: "Step 5ï¼šæœ€å¾Œæ”¶å°¾ï¼ˆç•¶å¤©æ‰é¸ï¼‰",
        hint: "æœ€å¾Œä¸€å€‹é¸æ“‡ï¼Œæ±ºå®šæ€éº¼æŠŠé€™ä¸€å¤©ç•™ä¸‹ä¾†ã€‚",
        mood: "å¿ƒå‹•æ”¶å°¾",
        options: {
          A: { big: "ğŸ“¸ æ‹ä¸€å¼µæ‹ç«‹å¾—", desc: "ç•™ä¸€å¼µå¯¦é«”çš„è­‰æ“šï¼Œè­‰æ˜æˆ‘å€‘ä»Šå¤©çœŸçš„å¾ˆå¿«æ¨‚ã€‚" },
          B: { big: "ğŸ’Œ æ‰‹å¯«å¿ƒå¾—å°å¡", desc: "æŠŠä»Šå¤©çš„å¿ƒæƒ…å¯«ä¸‹ä¾†ï¼Œåªé€ä¸€æ¬¡ï¼Œåªçµ¦ä»Šå¤©ã€‚" }
        }
      }
    ];

    // ===== DOM =====
    const els = {
      gateBox: document.getElementById('gateBox'),
      gateInput: document.getElementById('gateInput'),
      gateBtn: document.getElementById('gateBtn'),
      gateMsg: document.getElementById('gateMsg'),

      lockBox: document.getElementById('lockBox'),
      lockMsg: document.getElementById('lockMsg'),
      codeInput: document.getElementById('codeInput'),
      unlockBtn: document.getElementById('unlockBtn'),
      countdown: document.getElementById('countdown'),

      progressPill: document.getElementById('progressPill'),
      moodPill: document.getElementById('moodPill'),
      stepTitle: document.getElementById('stepTitle'),
      hint: document.getElementById('hint'),
      options: document.getElementById('options'),
      revealBtn: document.getElementById('revealBtn'),
      revealBox: document.getElementById('revealBox'),
      revealBig: document.getElementById('revealBig'),
      revealDesc: document.getElementById('revealDesc'),
      nextBtn: document.getElementById('nextBtn'),
      summary: document.getElementById('summary'),
      summaryList: document.getElementById('summaryList'),
      copyBtn: document.getElementById('copyBtn')
    };

    // ===== State =====
    let stepIndex = 0;
    let selectedKey = null; // 'A' | 'B' | 'C'
    const picks = []; // revealed big strings

    function scrollToEl(el) {
      try { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (e) {}
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (Array.isArray(data.picks)) data.picks.forEach((v, i) => (picks[i] = v));
        if (typeof data.stepIndex === 'number') stepIndex = data.stepIndex;
        if (data.unlocked === true) sessionStorage.setItem(STORAGE_KEY + '_unlocked', '1');
      } catch (e) {}
    }

    function saveState() {
      try {
        const data = {
          stepIndex,
          picks,
          unlocked: sessionStorage.getItem(STORAGE_KEY + '_unlocked') === '1'
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {}
    }

    function isDayUnlocked() {
      return sessionStorage.getItem(STORAGE_KEY + '_unlocked') === '1';
    }

    function updateLockUI() {
      els.countdown.textContent = isDayUnlocked()
        ? 'å·²è§£é– âœ… å¯ä»¥ç¹¼çºŒé¸æ“‡ï½'
        : 'è«‹è¼¸å…¥è§£é–ç¢¼ä¾†é–‹æ”¾ä¸‹ä¸€æ­¥ï½';
    }

    function buildLabel(index) {
      return `é¸é … ${index + 1}`;
    }

    function renderStep() {
      const step = steps[stepIndex];

      // end guard
      if (!step) {
        els.options.innerHTML = '';
        els.revealBtn.style.display = 'none';
        els.revealBox.classList.remove('show');
        els.lockBox.classList.remove('show');
        els.stepTitle.textContent = 'ğŸ‰ å®Œæˆï¼ä½ èµ°å‡ºä¸€æ¢å°ˆå±¬ç´„æœƒæ…¶ç”Ÿè·¯ç·š';
        els.hint.textContent = 'æŠŠçµæœæˆªåœ–æˆ–è¤‡è£½å‚³çµ¦å°æ–¹å§ï½';
        els.progressPill.textContent = `å®Œæˆ / ${steps.length} æ­¥`;
        els.moodPill.textContent = 'ä»Šæ—¥å¿ƒæƒ…ï¼šå¿ƒå‹•å®Œæˆ';
        showSummary();
        saveState();
        return;
      }

      els.revealBtn.style.display = '';
      els.progressPill.textContent = `æ­¥é©Ÿ ${stepIndex + 1} / ${steps.length}`;
      els.moodPill.textContent = `ä»Šæ—¥å¿ƒæƒ…ï¼š${step.mood}`;
      els.stepTitle.textContent = step.title;
      els.hint.textContent = step.hint;

      // lock logic for day steps
      const locked = (step.phase === 'day') && !isDayUnlocked();

      els.options.innerHTML = '';
      els.revealBox.classList.remove('show');
      els.revealBig.textContent = 'â€”';
      els.revealDesc.textContent = 'â€”';

      if (locked) {
        els.revealBtn.disabled = true;
        els.lockMsg.textContent = 'é€™ä¸€æ­¥å…ˆä¿ç•™åˆ°ç´„æœƒç•¶å¤© ğŸ’–';
        els.lockBox.classList.add('show');
        updateLockUI();
        saveState();
        return;
      }

      // unlocked: hide lock UI
      els.lockBox.classList.remove('show');

      const keys = Object.keys(step.options);
      els.options.classList.toggle('three', keys.length === 3);

      keys.forEach((key, idx) => {
        const div = document.createElement('div');
        div.className = 'option';
        div.dataset.value = key;
        div.innerHTML = `<b>${buildLabel(idx)}</b><small>é»æˆ‘é¸æ“‡ï¼ˆå…ˆä¸æ­æ›‰ï¼‰</small>`;
        div.addEventListener('click', () => {
          Array.from(els.options.children).forEach(c => c.classList.remove('selected'));
          div.classList.add('selected');
          selectedKey = key;
          els.revealBtn.disabled = false;
          els.revealBox.classList.remove('show');
        });
        els.options.appendChild(div);
      });

      selectedKey = null;
      els.revealBtn.disabled = true;
      saveState();
    }

    function reveal() {
      if (!selectedKey) return;
      const step = steps[stepIndex];
      const payload = step.options[selectedKey];

      els.revealBig.textContent = payload.big;
      els.revealDesc.textContent = payload.desc;
      els.revealBox.classList.add('show');

      if (!picks[stepIndex]) picks[stepIndex] = payload.big;
      saveState();
    }

    function next() {
      if (!picks[stepIndex]) return; // must reveal before next
      stepIndex++;
      saveState();
      renderStep();
    }

    function showSummary() {
      els.summaryList.innerHTML = '';
      picks.forEach((p, i) => {
        const li = document.createElement('li');
        li.textContent = `Step ${i + 1}ï¼š${p}`;
        els.summaryList.appendChild(li);
      });
      els.summary.classList.add('show');
    }

    async function copySummary() {
      const lines = picks.map((p, i) => `Step ${i + 1}ï¼š${p}`);
      const text = `æˆ‘çš„ç´„æœƒæ…¶ç”Ÿè·¯ç·š\n${lines.join('\n')}`;
      try {
        await navigator.clipboard.writeText(text);
        els.copyBtn.textContent = 'å·²è¤‡è£½ âœ…';
        setTimeout(() => (els.copyBtn.textContent = 'è¤‡è£½çµæœ'), 1200);
      } catch (e) {
        prompt('è¤‡è£½ä»¥ä¸‹æ–‡å­—ï¼š', text);
      }
    }

    // ===== Self tests (console) =====
    function runSelfTests() {
      const requiredEls = [
        // gate
        'gateBox','gateInput','gateBtn','gateMsg',
        // lock
        'lockBox','lockMsg','codeInput','unlockBtn','countdown',
        // main
        'progressPill','moodPill','stepTitle','hint','options','revealBtn',
        'revealBox','revealBig','revealDesc','nextBtn','summary','summaryList','copyBtn'
      ];
      requiredEls.forEach(k => console.assert(!!els[k], `Missing element: ${k}`));

      console.assert(typeof scrollToEl === 'function', 'scrollToEl should be a function');
      console.assert(Array.isArray(steps) && steps.length === 5, 'steps should be an array of length 5');

      steps.forEach((s, i) => {
        console.assert(s && (s.phase === 'pre' || s.phase === 'day'), `steps[${i}].phase must be pre/day`);
        console.assert(s.options && Object.keys(s.options).length >= 2, `steps[${i}] must have 2+ options`);
        Object.keys(s.options).forEach(k => {
          console.assert(typeof s.options[k].big === 'string', `steps[${i}].options.${k}.big must be string`);
          console.assert(typeof s.options[k].desc === 'string', `steps[${i}].options.${k}.desc must be string`);
        });
      });

      // Step1 should be 3 options
      console.assert(Object.keys(steps[0].options).length === 3, 'Step 1 should have 3 options');

      // unlock mode sanity
      console.assert(unlockConfig.unlockAtISO === null, 'unlockAtISO should be null when using code-only unlock');
      console.assert(typeof unlockConfig.unlockCode === 'string' && unlockConfig.unlockCode.length > 0, 'unlockCode should be a non-empty string');

      // gate phrase sanity
      console.assert(typeof GATE_PHRASE === 'string' && GATE_PHRASE.length >= 2, 'GATE_PHRASE should be a non-empty string');

      const sample = `æˆ‘çš„ç´„æœƒæ…¶ç”Ÿè·¯ç·š\nStep 1ï¼šX`;
      console.assert(sample.includes('\n'), 'copy summary should contain newline characters');
    }

    // ===== Events =====
    els.revealBtn.addEventListener('click', reveal);
    els.nextBtn.addEventListener('click', next);
    els.copyBtn.addEventListener('click', copySummary);

    function tryUnlock() {
      const code = (els.codeInput.value || '').trim();
      const required = (unlockConfig.unlockCode || '').trim();

      if (code && required && code === required) {
        sessionStorage.setItem(STORAGE_KEY + '_unlocked', '1');
        els.lockMsg.textContent = 'è§£é–æˆåŠŸ âœ… ç´„æœƒç•¶å¤©é¸é …å·²é–‹æ”¾';
        els.codeInput.value = '';
        saveState();
        renderStep();
      } else {
        els.lockMsg.textContent = 'è§£é–ç¢¼ä¸å°å–” ğŸ¥º å†è©¦ä¸€æ¬¡ï½';
        updateLockUI();
      }
    }

    els.unlockBtn.addEventListener('click', tryUnlock);
    els.codeInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') tryUnlock();
    });
    els.codeInput.addEventListener('focus', () => scrollToEl(els.lockBox));

    // ===== Gate animations + hints =====
    let gateAttempts = 0;

    function gateHint(attempt) {
      if (attempt <= 1) return 'å¥½åƒä¸å¤ªå°ï¼Œå†æƒ³ä¸€ä¸‹ ğŸ’­ï¼ˆæç¤ºï¼šä»¥ã€Œæˆ‘æ„›ã€é–‹é ­ï¼‰';
      if (attempt === 2) return 'å†è¿‘ä¸€é»é»ï¼šäº”å€‹å­—ï¼Œå‰å…©å€‹å­—æ˜¯ã€Œæˆ‘æ„›ã€âœ¨';
      if (attempt === 3) return 'æœ€å¾Œæç¤ºï¼šæˆ‘æ„› + ä¸€å€‹äººçš„å…¨åï¼ˆå››å€‹å­—ï¼‰';
      return 'å·²ç¶“å¾ˆæ¥è¿‘äº†ï¼Œå†è©¦ä¸€æ¬¡ï½';
    }

    function burstHearts() {
      const box = els.gateBox;
      const hearts = ['ğŸ’–','ğŸ’—','ğŸ’˜','ğŸ’•'];
      for (let i = 0; i < 10; i++) {
        const h = document.createElement('div');
        h.className = 'heart';
        h.textContent = hearts[i % hearts.length];
        const x = 12 + Math.random() * 76;
        h.style.left = x + '%';
        h.style.animationDelay = (Math.random() * 0.12) + 's';
        h.style.fontSize = (14 + Math.random() * 10) + 'px';
        box.appendChild(h);
        setTimeout(() => h.remove(), 1100);
      }
    }

    function shakeGate() {
      els.gateBox.classList.remove('shake');
      void els.gateBox.offsetWidth;
      els.gateBox.classList.add('shake');
    }

    function tryGate() {
      const v = (els.gateInput.value || '').trim();
      if (v === GATE_PHRASE) {
        sessionStorage.setItem(STORAGE_KEY + '_gate', '1');
        els.gateMsg.textContent = 'é€šé—œæˆåŠŸ âœ… é€²å…¥ä»Šå¤©çš„é¸æ“‡â€¦';
        els.gateBox.classList.add('pop');
        burstHearts();
        setTimeout(() => {
          els.gateBox.classList.add('gate-success');
          setTimeout(() => {
            els.gateBox.classList.remove('show');
            els.gateBox.style.display = 'none';
            renderStep();
          }, 260);
        }, 420);
      } else {
        gateAttempts += 1;
        els.gateMsg.textContent = gateHint(gateAttempts);
        shakeGate();
      }
    }

    els.gateBtn.addEventListener('click', tryGate);
    els.gateInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') tryGate();
    });
    els.gateInput.addEventListener('focus', () => scrollToEl(els.gateBox));

    // ===== Init =====
    loadState();
    runSelfTests();

    // è‹¥å°šæœªé€šéé€šé—œå¯†èªï¼Œå…ˆåœåœ¨ gate
    if (sessionStorage.getItem(STORAGE_KEY + '_gate') === '1') {
      els.gateBox.style.display = 'none';
      renderStep();
    } else {
      els.options.innerHTML = '';
      els.revealBtn.disabled = true;
      els.lockBox.classList.remove('show');
      els.stepTitle.textContent = 'â€”';
      els.hint.textContent = 'â€”';
      updateLockUI();
    }
  </script>
</body>
</html>
